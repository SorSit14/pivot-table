function renderTable(months, stations, pivot) {
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // ========== Header 3 ชั้น ==========
  const tr1 = document.createElement('tr'); // row 1: เดือน-ปี + สถานี
  const tr2 = document.createElement('tr'); // row 2: ต้นที่
  const tr3 = document.createElement('tr'); // row 3: GBH + ความสูง

  // คอลัมน์แรก (เดือน-ปี)
  const thDate = document.createElement('th');
  thDate.rowSpan = 3;
  thDate.textContent = 'เดือน-ปี';
  tr1.appendChild(thDate);

  stations.forEach(st => {
    // หาจำนวนต้นสูงสุดที่สถานีนี้มี
    const maxTrees = Math.max(...months.map(m => {
      return pivot[m][st] ? Object.keys(pivot[m][st]).length : 0;
    }));

    // หัวสถานี
    const thStation = document.createElement('th');
    thStation.colSpan = maxTrees * 2; // ต้นละ 2 คอลัมน์ (GBH+ความสูง)
    thStation.textContent = st;
    tr1.appendChild(thStation);

    // หัวต้นที่
    for (let t = 1; t <= maxTrees; t++) {
      const thTree = document.createElement('th');
      thTree.colSpan = 2;
      thTree.textContent = "ต้นที่ " + t;
      tr2.appendChild(thTree);

      // หัวย่อย GBH + ความสูง
      const thGBH = document.createElement('th'); thGBH.textContent = "GBH";
      const thH   = document.createElement('th'); thH.textContent = "ความสูง";
      tr3.appendChild(thGBH);
      tr3.appendChild(thH);
    }
  });

  thead.appendChild(tr1);
  thead.appendChild(tr2);
  thead.appendChild(tr3);

  // ========== Body ==========
  const aggSelect = document.getElementById('agg');
  const aggMode = () => aggSelect.value;

  aggSelect.onchange = () => {
    tbody.innerHTML = '';
    months.forEach(month => {
      const tr = document.createElement('tr');
      const tdMonth = document.createElement('td');
      tdMonth.textContent = month;
      tr.appendChild(tdMonth);

      stations.forEach(st => {
        const trees = pivot[month][st] || {};
        const maxTrees = Math.max(...months.map(m => {
          return pivot[m][st] ? Object.keys(pivot[m][st]).length : 0;
        }));

        for (let t = 1; t <= maxTrees; t++) {
          const info = trees[t] || null;
          let vGBH = '', vH = '';

          if (info) {
            if (aggMode() === 'avg') {
              vGBH = info.cntGBH ? fmtNumber(info.sumGBH / info.cntGBH, 2) : '';
              vH   = info.cntH   ? fmtNumber(info.sumH   / info.cntH, 2)   : '';
            } else if (aggMode() === 'sum') {
              vGBH = info.cntGBH ? fmtNumber(info.sumGBH, 2) : '';
              vH   = info.cntH   ? fmtNumber(info.sumH, 2)   : '';
            } else if (aggMode() === 'last') {
              vGBH = info.lastGBH !== null ? fmtNumber(info.lastGBH, 2) : '';
              vH   = info.lastH   !== null ? fmtNumber(info.lastH, 2)   : '';
            }
          }

          const tdG = document.createElement('td'); tdG.textContent = vGBH || ''; if (!vGBH) tdG.className = 'empty';
          const tdH = document.createElement('td'); tdH.textContent = vH || ''; if (!vH) tdH.className = 'empty';
          tr.appendChild(tdG);
          tr.appendChild(tdH);
        }
      });
      tbody.appendChild(tr);
    });
  };

  aggSelect.dispatchEvent(new Event('change'));
}
