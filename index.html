<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Pivot: สถานีควบคุมไฟป่า (GBH / ความสูง)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "TH Sarabun New", Arial, sans-serif; background:#f6fff6; padding:18px; color:#123; }
    h1 { color:#174b2a; }
    table { width:100%; border-collapse:collapse; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.12); background:#fff; }
    th, td { border:1px solid #cfcfcf; padding:6px 8px; font-size:13px; }
    thead th { background:#1c4526; color:#fff; }
    thead tr.level2 th { background:#2e6a42; }
    thead tr.level3 th { background:#4a8a60; color:#fff; }
    tbody tr:nth-child(even) { background:#fbfdfb; }
    td.empty { color:#999; }
    .note { margin-top:8px; color:#555; font-size:13px; }
    .controls { margin-bottom:10px; display:flex; gap:8px; align-items:center; }
    select { padding:6px; }
    tr.summary { font-weight:bold; background:#e0ffe0; }
  </style>
</head>
<body>
  <h1>รายงาน (Pivot) — สถานีควบคุมไฟป่า</h1>

  <div class="controls">
    <label>Aggregation:
      <select id="agg">
        <option value="avg">Average (ค่าเฉลี่ย)</option>
        <option value="sum">Sum (รวม)</option>
        <option value="last">Last (ค่าใหม่สุด)</option>
      </select>
    </label>
  </div>

  <div id="table-wrap">
    <table id="pivot-table">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
  // === CONFIG ===
  const sheetId = "1JacSgbSOWejInZHZrcft8zTWkVdTUvz8bQexL5Lnqus";  // Spreadsheet ID
  const sheetName = "Sheet1"; // ชื่อแท็บ
  const apiKey = "AIzaSyBV4U4vhac2gOC9efcYanjMBq2IJ0oHuys";       // API Key
  // ==============

  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheetName)}?key=${apiKey}`;

  function parseNumber(v) {
    if (v === undefined || v === null) return NaN;
    v = String(v).trim().replace(/,/g,'');
    if (v === '' || v === '-') return NaN;
    return parseFloat(v);
  }
  function normalizeMonthYear(raw) {
    if (!raw) return null;
    const d = new Date(raw);
    if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    return raw;
  }
  function fmtNumber(v, d=2){ return (v===null||isNaN(v))?'':(+v).toFixed(d).replace(/\.00$/,''); }

  fetch(url)
    .then(r => r.json())
    .then(json => {
      const values = json.values || [];
      const headers = values[0].map(h => h.trim());
      const rows = values.slice(1);

      const idxStation = headers.findIndex(h=>h.includes("สถานี")||h.includes("หน่วยงาน"));
      const idxTree = headers.findIndex(h=>h.includes("ต้นที่"));
      const idxGBH = headers.findIndex(h=>h.toLowerCase().includes("gbh")||h.includes("ความโต"));
      const idxH = headers.findIndex(h=>h.includes("ความสูง"));
      const idxDate = headers.findIndex(h=>h.includes("วัน")||h.toLowerCase().includes("date"));

      const pivot = {};
      const stationsOrder = [];
      const stationTrees = {};

      rows.forEach(r=>{
        const station = r[idxStation]||"";
        const tree = r[idxTree]||"1";
        const gbh = parseNumber(r[idxGBH]);
        const h = parseNumber(r[idxH]);
        const date = normalizeMonthYear(r[idxDate]);

        if (!station || !date) return;
        if (!stationsOrder.includes(station)) stationsOrder.push(station);
        if (!stationTrees[station]) stationTrees[station]=[];
        if (!stationTrees[station].includes(tree)) stationTrees[station].push(tree);

        if (!pivot[date]) pivot[date]={};
        if (!pivot[date][station]) pivot[date][station]={};
        if (!pivot[date][station][tree]) pivot[date][station][tree]={gbh:[],h:[]};

        if (!isNaN(gbh)) pivot[date][station][tree].gbh.push(gbh);
        if (!isNaN(h)) pivot[date][station][tree].h.push(h);
      });

      const months = Object.keys(pivot).sort();
      renderTable(months, stationsOrder, stationTrees, pivot);
    });

  function renderTable(months, stations, stationTrees, pivot){
    const thead=document.getElementById("thead");
    const tbody=document.getElementById("tbody");
    thead.innerHTML=""; tbody.innerHTML="";

    // แถวหัวใหญ่ (สถานี)
    const tr1=document.createElement("tr");
    const thDate=document.createElement("th"); thDate.rowSpan=3; thDate.textContent="เดือน-ปี"; tr1.appendChild(thDate);
    stations.forEach(st=>{
      const th=document.createElement("th");
      th.colSpan=stationTrees[st].length*2;
      th.textContent=st;
      tr1.appendChild(th);
    });
    thead.appendChild(tr1);

    // แถวต้นไม้
    const tr2=document.createElement("tr"); tr2.className="level2";
    stations.forEach(st=>{
      stationTrees[st].forEach(tree=>{
        const th=document.createElement("th");
        th.colSpan=2;
        th.textContent="ต้นที่ "+tree;
        tr2.appendChild(th);
      });
    });
    thead.appendChild(tr2);

    // แถว GBH / H
    const tr3=document.createElement("tr"); tr3.className="level3";
    stations.forEach(st=>{
      stationTrees[st].forEach(()=>{
        const th1=document.createElement("th"); th1.textContent="GBH"; tr3.appendChild(th1);
        const th2=document.createElement("th"); th2.textContent="ความสูง"; tr3.appendChild(th2);
      });
    });
    thead.appendChild(tr3);

    // helper คำนวณ
    const agg=document.getElementById("agg");
    function calc(arr,mode){
      if(!arr||arr.length===0) return NaN;
      if(mode==="avg") return arr.reduce((a,b)=>a+b,0)/arr.length;
      if(mode==="sum") return arr.reduce((a,b)=>a+b,0);
      if(mode==="last") return arr[arr.length-1];
    }

    function renderBody(){
      tbody.innerHTML="";
      const summaryRow={};

      months.forEach(m=>{
        const tr=document.createElement("tr");
        const tdMonth=document.createElement("td"); tdMonth.textContent=m; tr.appendChild(tdMonth);
        stations.forEach(st=>{
          stationTrees[st].forEach(tree=>{
            const info=pivot[m]&&pivot[m][st]&&pivot[m][st][tree]?pivot[m][st][tree]:null;
            const tdG=document.createElement("td");
            const tdH=document.createElement("td");
            if(info){
              const g=calc(info.gbh,agg.value);
              const h=calc(info.h,agg.value);
              tdG.textContent=fmtNumber(g); 
              tdH.textContent=fmtNumber(h);
              if(!summaryRow[st]) summaryRow[st]={};
              if(!summaryRow[st][tree]) summaryRow[st][tree]={gbh:[],h:[]};
              if(!isNaN(g)) summaryRow[st][tree].gbh.push(g);
              if(!isNaN(h)) summaryRow[st][tree].h.push(h);
            } else { tdG.className="empty"; tdH.className="empty"; }
            tr.appendChild(tdG); tr.appendChild(tdH);
          });
        });
        tbody.appendChild(tr);
      });

      // แถวสรุปค่าเฉลี่ยรวม
      const tr=document.createElement("tr"); tr.className="summary";
      const tdLabel=document.createElement("td"); tdLabel.textContent="ค่าเฉลี่ย"; tr.appendChild(tdLabel);
      stations.forEach(st=>{
        stationTrees[st].forEach(tree=>{
          const tdG=document.createElement("td");
          const tdH=document.createElement("td");
          const g=summaryRow[st]&&summaryRow[st][tree]?calc(summaryRow[st][tree].gbh,"avg"):NaN;
          const h=summaryRow[st]&&summaryRow[st][tree]?calc(summaryRow[st][tree].h,"avg"):NaN;
          tdG.textContent=fmtNumber(g);
          tdH.textContent=fmtNumber(h);
          tr.appendChild(tdG); tr.appendChild(tdH);
        });
      });
      tbody.appendChild(tr);
    }
    agg.onchange=renderBody;
    renderBody();
  }
  </script>
</body>
</html>
